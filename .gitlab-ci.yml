variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  FF_USE_LEGACY_ARTIFACTS_UPLOAD: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fastest"
  TRANSFER_METER_FREQUENCY: "2s"
  GIT_STRATEGY: clone
  ALLURE_VERSION: "2.24.0"

image: maven:3.9.6-eclipse-temurin-17

services:
  - name: selenium/standalone-chrome:latest
    alias: selenium-chrome

cache:
  paths:
    - .m2/repository
  key: "$CI_COMMIT_REF_SLUG"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'external_pull_request_event'
      when: never
    - when: always

stages:
  - test
  - report
  - deploy

test:
  stage: test
  script:
    - echo "ðŸš€ Tests baÅŸlatÄ±lÄ±yor..."
    - apt-get update && apt-get install -y wget unzip
    - mvn clean test -Dcucumber.plugin="pretty,html:target/cucumber-reports/report.html,json:target/cucumber-reports/cucumber.json,io.qameta.allure.cucumber7jvm.AllureCucumber7Jvm"
    - mvn allure:report
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/allure-results
      - target/allure-report
      - target/cucumber-reports
      - target/surefire-reports
    expire_in: 1 week

allure-report:
  stage: report
  script:
    - mkdir -p public/cucumber-report public/allure-report
    - cp -r target/cucumber-reports/* public/cucumber-report/ || true
    - cp -r target/allure-report/* public/allure-report/ || true
    - |
      cat << 'EOF' > public/index.html
      <!DOCTYPE html>
      <html>
      <head>
          <meta charset="utf-8">
          <title>Test Reports</title>
          <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #333; }
              .reports { margin-top: 20px; }
              a { color: #0366d6; text-decoration: none; padding: 10px; display: block; }
              a:hover { background: #f6f8fa; }
          </style>
      </head>
      <body>
          <h1>Test RaporlarÄ±</h1>
          <div class="reports">
              <a href="./allure-report/index.html">Allure Report</a>
              <a href="./cucumber-report/report.html">Cucumber Report</a>
          </div>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public
    expire_in: 30 days
  dependencies:
    - test

pages:
  stage: deploy
  script:
    - cp -r public/* public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  dependencies:
    - allure-report
  only:
    - main