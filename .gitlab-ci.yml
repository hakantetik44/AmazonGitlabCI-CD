variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  CHROME_OPTIONS: "--no-sandbox --headless --disable-dev-shm-usage"
  DOCKER_TLS_CERTDIR: "/certs"
  CHROMEDRIVER_VERSION: "114.0.5735.90"
  FF_USE_LEGACY_ARTIFACTS_UPLOAD: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fastest"
  TRANSFER_METER_FREQUENCY: "2s"
  GIT_STRATEGY: clone

image: maven:3.9.6-eclipse-temurin-17

services:
  - name: docker:dind
    command: ["--tls=false"]

cache:
  paths:
    - .m2/repository
    - .cache/selenium
  key: "$CI_COMMIT_REF_SLUG"

stages:
  - test
  - deploy

test:
  stage: test
  before_script:
    - apt-get update && apt-get install -y wget unzip curl gnupg2
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list
    - apt-get update && apt-get install -y google-chrome-stable
    - mkdir -p .cache/selenium
    - wget -q -O /tmp/chromedriver.zip "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/114.0.5735.90/linux64/chromedriver-linux64.zip"
    - unzip -q /tmp/chromedriver.zip -d /tmp
    - mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
    - chmod +x /usr/local/bin/chromedriver
    - echo "Chrome version: $(google-chrome --version)"
    - echo "ChromeDriver version: $(chromedriver --version)"
    - export CHROME_BIN=/usr/bin/google-chrome

  script:
    - echo "🚀 Starting test execution..."
    - java -version
    - mvn -version
    - export CHROME_OPTIONS="--headless --no-sandbox --disable-dev-shm-usage --disable-gpu --remote-debugging-port=9222"
    
    # Maven testlerini çalıştır
    - |
      echo "Maven testleri başlıyor..."
      mvn clean test allure:report || {
        echo "⚠️ Test veya rapor oluşturmada hata"
        mkdir -p target/allure-results target/allure-report target/surefire-reports
        touch target/allure-results/.gitkeep
        touch target/allure-report/.gitkeep
        touch target/surefire-reports/.gitkeep
      }
    
    # Test sonuçlarını kontrol et
    - |
      if [ -d "target" ]; then
        echo "📁 Target dizini içeriği:"
        ls -la target/
        
        # Test raporlarını kopyala
        if [ -d "target/surefire-reports" ]; then
          echo "📋 Test raporları bulundu"
          cp -r target/surefire-reports .
        fi
        
        # Allure raporlarını kopyala
        if [ -d "target/allure-results" ]; then
          echo "📊 Allure raporları bulundu"
          cp -r target/allure-results .
        fi
        
        # Artifactları hazırla
        echo "🗜️ Artifactlar hazırlanıyor..."
        tar czf artifacts.tar.gz target/ || echo "⚠️ Tar işlemi başarısız"
        echo "✅ Artifact hazırlama tamamlandı"
      else
        echo "⚠️ Target dizini bulunamadı, minimum yapı oluşturuluyor..."
        mkdir -p target/surefire-reports
        touch target/surefire-reports/.gitkeep
        tar czf artifacts.tar.gz target/
      fi

  after_script:
    - echo "🧹 Geçici dosyalar temizleniyor..."
    - find . -type f -name "*.tmp" -delete
    - find . -type f -size +100M -delete

  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
        - surefire-reports/TEST-*.xml
    paths:
      - artifacts.tar.gz
      - target/
      - target/surefire-reports/
      - target/allure-results/
      - target/allure-report/
      - surefire-reports/
      - allure-results/
    expire_in: 1 week

  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

  rules:
    - if: $CI_COMMIT_BRANCH
      when: always

pages:
  stage: deploy
  dependencies:
    - test
  script:
    - mkdir -p public
    
    # Test raporlarını yerleştir
    - |
      if [ -f artifacts.tar.gz ]; then
        echo "📦 Artifactlar çıkartılıyor..."
        tar xzf artifacts.tar.gz
      else
        echo "⚠️ Artifacts bulunamadı"
        echo "<html><body><h1>Test Sonuçları Mevcut Değil</h1></body></html>" > public/index.html
      fi
    
    # Allure raporlarını kopyala
    - |
      if [ -d "target/allure-report" ]; then
        echo "📊 Allure raporları kopyalanıyor..."
        cp -r target/allure-report/* public/
      else
        echo "⚠️ Allure raporu bulunamadı"
        echo "<html><body><h1>Test Raporu Mevcut Değil</h1></body></html>" > public/index.html
      fi
    
    # Özet rapor oluştur
    - |
      {
        echo "Test Özeti"
        echo "==========="
        echo "Build: $CI_BUILD_ID"
        echo "Branch: $CI_COMMIT_REF_NAME"
        echo "Commit: $CI_COMMIT_SHA"
        echo "Tarih: $(date)"
        echo
        echo "Test Sonuçları"
        echo "=============="
        
        if [ -d "target/surefire-reports" ]; then
          TOTAL_TESTS=$(grep -h "<testcase" target/surefire-reports/TEST-*.xml 2>/dev/null | wc -l)
          FAILED_TESTS=$(grep -h "<failure" target/surefire-reports/TEST-*.xml 2>/dev/null | wc -l)
          echo "Toplam Test: $TOTAL_TESTS"
          echo "Başarısız Test: $FAILED_TESTS"
        else
          echo "Test sonuçları bulunamadı"
        fi
      } > public/summary.txt

  artifacts:
    paths:
      - public
    expire_in: 30 days
    
  only:
    - main